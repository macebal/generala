<!-- chat/templates/chat/room.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
</head>
<body>
    <textarea id="chat-log" cols="100" rows="20"></textarea><br>
    <input id="chat-message-input" type="text" size="100"><br>
    <input id="chat-message-submit" type="button" value="Send">
    {{ room_name|json_script:"room-name" }}
    <br><br>
    <input id="dice-roll" type="button" value="Roll Dice">
    <p>Current dies values <em id="dies-values"></em></p>
    <br>
    <div>
        <select id="play-type">
            <option value="">Select play type...</option>
            <optgroup label="Numbers">
                <option value="number_1">Number 1</option>
                <option value="number_2">Number 2</option>
                <option value="number_3">Number 3</option>
                <option value="number_4">Number 4</option>
                <option value="number_5">Number 5</option>
                <option value="number_6">Number 6</option>
            </optgroup>
            <optgroup label="Special Plays">
                <option value="straight">Straight</option>
                <option value="full_house">Full House</option>
                <option value="poker">Poker</option>
                <option value="generala">Generala</option>
                <option value="double_generala">Double Generala</option>
            </optgroup>
        </select>
        <input id="play-score" type="number" placeholder="Score">
        <input id="play-submit" type="button" value="Submit Play">
    </div>
    <br>
    <input id="finish-turn" type="button" value="Finish Turn">
    <br>
    Player list
    <ul id="player-list"></ul>
    <p>It is player <em id="current-player-turn-id">foo</em>'s turn</p>
    <input id="game-start" type="button" value="START GAME">
    <input id="game-finish" type="button" value="FINISH GAME">
    <p>Current game status <em id="game-status">waiting for players</em></p>
    <script>
        function getOrCreateUserId() {
            const storageKey = "user_id";
            let userId = localStorage.getItem(storageKey);
    
            if (!userId) {
                userId = generateRandomId();
                localStorage.setItem(storageKey, userId);
            }
    
            return userId;
        }
    
        function generateRandomId() {
            const randomPart = Math.random().toString(36).substring(2, 8);
            return `user-${randomPart}`;
        }
    
        const userId = getOrCreateUserId();
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
    
        const gameSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/game/'
            + roomName
            + '/?player_id='
            + encodeURIComponent(userId)
        );
            
        gameSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.type == 'chat.message') {
                document.querySelector('#chat-log').value += (data.content.message + '\n');    
            } else if (data.type == 'dice.roll.result') {
                console.log("Rolled dice:", data.content.result);
            } else if (data.type == 'game.status') {
                document.querySelector('#player-list').innerHTML = '';
                const content = JSON.parse(data.content);
                const players = Object.keys(content.scores_per_player); // usernames like 'user-jwgktz', 'user-ou73ev'

                players.forEach(element => {
                    const li = document.createElement('li');
                    li.textContent = element;
                    document.querySelector('#player-list').appendChild(li);
                });

                const gameStatus = document.querySelector('#game-status')
                gameStatus.innerHTML = content.status == "pending" ? "waiting for players" : content.status

                const diesValues = document.querySelector('#dies-values')
                diesValues.innerHTML = content.dies_values
            }
        };
    
        gameSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };
    
        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.key === 'Enter') {
                document.querySelector('#chat-message-submit').click();
            }
        };
    
        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            gameSocket.send(JSON.stringify({
                'type': 'chat.message',
                'content': {
                    'message': message,
                }
            }));
            messageInputDom.value = '';
        };
    
        document.querySelector('#dice-roll').onclick = function(e) {
            gameSocket.send(JSON.stringify({
                'type': 'dice.roll',
                'content': {
                    'keepers': [4],
                }
            }));
        };
        document.querySelector('#finish-turn').onclick = function(e) {
            gameSocket.send(JSON.stringify({
                'type': 'player.turn.finish',
                'content': null
            }));
        };
        document.querySelector('#game-start').onclick = function(e) {
            gameSocket.send(JSON.stringify({
                'type': 'game.status.change',
                'content': {
                    'newStatus': 'playing'
                }
            }));
        };
        document.querySelector('#game-finish').onclick = function(e) {
            gameSocket.send(JSON.stringify({
                'type': 'game.status.change',
                'content': {
                    'newStatus': 'finished'
                }
            }));
        };
        document.querySelector('#play-submit').onclick = function(e) {
            const playType = document.querySelector('#play-type').value;
            const playScore = document.querySelector('#play-score').value;
            
            if (!playType || !playScore) {
                alert('Please select a play type and enter a score');
                return;
            }

            gameSocket.send(JSON.stringify({
                'type': 'player.play.score',
                'content': {
                    'play': playType,
                    'value': parseInt(playScore)
                }
            }));
        };
    </script>    
</body>
</html>